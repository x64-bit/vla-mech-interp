# Residual Capture Summary – 2025-12-04 10:55:00

## Additions & Code Changes
- Enhanced `ResidualRecorder` to store both selected and full tensors for instruction slicing.
- Updated `save_residuals.py` with instruction extraction fix, progress logging, timestamped outputs.
- Introduced `_LayerWriter` refactor and `_AdaRMSWriter/_AdaRMSCapture` for storing conditioning vectors.
- Exposed AdaRMS callbacks in `PI0Pytorch` to keep conditioners aligned with decision tokens.
- Added documentation detailing new outputs (`decision/`, `instructions/`, `adarms/`).

## Usage Tutorials
1. **Run residual export**
   ```bash
   uv run -m openpi.analysis.save_residuals \
     --args.checkpoint-path data/openpi-assets/checkpoints/pi05_libero_pytorch/model.safetensors \
     --args.output-dir data/residuals/pi0_libero/test_run \
     --args.layers 14 --args.batch-size 64 --args.max-batches 1 \
     --args.auto-timestamp --args.progress-interval 1
   ```
2. **Decode tokens from residuals**
   ```python
   residuals = torch.load('.../decision/layer14_chunk0000.pt')
   adarms = torch.load('.../adarms/chunk0000.pt')
   normed, _ = model.paligemma_with_expert.gemma_expert.model.norm(residuals, adarms)
   logits = normed @ model.paligemma_with_expert.gemma_expert.lm_head.weight.T
   ```
3. **Monitor long capture**
   Tail `/home/ubuntu/.cursor/projects/home-ubuntu-eecs182proj/terminals/<id>.txt` for progress output.

## Important Concepts
- **Residual Recorder**: forward hooks capturing Gemma decoder layer outputs with token selectors.
- **Instruction tokens**: require full residual tensors and prompt masks for slicing.
- **AdaRMS conditioning**: per-step timestep embedding appended to RMSNorm; now stored under `adarms/` for logit reconstruction.
- **SAE fine-tuning**: use pre-trained Gemma SAE as initialization, stream residual shards (decision/instruction) as training data.
- **Token projections**: direct `lm_head` decoding from decision residuals is noisy—indicates re-purposed residual space suited for SAE intervention.
- **LIBERO-90 capture**: configured to export layers 6/10/14 at batch size 128 with timestamped directories.

